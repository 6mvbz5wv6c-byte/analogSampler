<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pigboy Geophone Oscilloscope</title>
  <link rel="stylesheet" href="/static/vendor/uplot-lite.css">
  <style>
    :root {
      --bg: #111;
      --panel: #1b1b1b;
      --accent: #0f0;
      --grid: #222;
      --text: #e8e8e8;
      --warn: #f80;
      --error: #f55;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      padding: 10px 14px;
      background: var(--panel);
      font-size: 14px;
      border-bottom: 1px solid #2a2a2a;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    #status {
      font-weight: 700;
    }

    #container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    #chart {
      width: 100%;
      max-width: 1100px;
      height: 480px;
    }
  </style>
</head>
<body>
  <header>
    <div>Pigboy Geophone Monitor</div>
    <div id="status">Connecting...</div>
  </header>
  <div id="container">
    <div id="chart"></div>
  </div>

  <script src="/static/vendor/uplot-lite.js"></script>
  <script>
    const statusEl = document.getElementById('status');
    const chartEl = document.getElementById('chart');

    const WINDOW_SECONDS = 10;
    const state = {
      times: [],
      geo: [],
      plot: null,
    };

    function initChart() {
      const plot = new uPlot({
        width: chartEl.clientWidth,
        height: chartEl.clientHeight,
        background: '#000',
        axes: [
          { label: 'Seconds', stroke: '#999' },
          { label: 'Volts', stroke: '#999' }
        ],
        series: [
          {},
          { label: 'Geophone', stroke: '#0f0', width: 1.5 }
        ],
        resize: () => ({
          width: chartEl.clientWidth,
          height: chartEl.clientHeight,
        }),
      }, [[], []], chartEl);

      state.plot = plot;
    }

    function updateChart(newTimes, newGeo) {
      if (!state.plot) return;

      state.times.push(...newTimes);
      state.geo.push(...newGeo);

      if (state.times.length === 0) return;

      const latest = state.times[state.times.length - 1];
      const cutoff = latest - WINDOW_SECONDS;

      while (state.times.length && state.times[0] < cutoff) {
        state.times.shift();
        state.geo.shift();
      }

      const displayTimes = state.times.map(t => t - cutoff);
      state.plot.setData([displayTimes, state.geo]);
    }

    function connectWS() {
      const proto = (location.protocol === 'https:') ? 'wss://' : 'ws://';
      const wsUrl = proto + location.host + '/ws';
      const ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        statusEl.textContent = 'Connected';
        statusEl.style.color = 'var(--accent)';
      };

      ws.onclose = () => {
        statusEl.textContent = 'Disconnected, retrying...';
        statusEl.style.color = 'var(--warn)';
        setTimeout(connectWS, 2000);
      };

      ws.onerror = () => {
        statusEl.textContent = 'Error';
        statusEl.style.color = 'var(--error)';
      };

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          const t = msg.t || [];
          const geo = msg.geo || [];
          if (t.length && geo.length) {
            updateChart(t, geo);
          }
        } catch (e) {
          console.error('Bad message', e);
        }
      };
    }

    initChart();
    connectWS();
  </script>
</body>
</html>
