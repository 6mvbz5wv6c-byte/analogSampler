<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pigboy Geophone Oscilloscope</title>
  <link rel="stylesheet" href="/static/vendor/uplot-lite.css">
  <style>
    :root {
      --bg: #111;
      --panel: #1b1b1b;
      --accent: #6cff5f;
      --grid: #222;
      --text: #e8e8e8;
      --warn: #f9a825;
      --error: #ef5350;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      padding: 10px 14px;
      background: var(--panel);
      font-size: 14px;
      border-bottom: 1px solid #2a2a2a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      letter-spacing: 0.3px;
    }

    #status {
      font-weight: 700;
      transition: color 0.2s ease;
    }

    #container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
    }
    #controls {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 16px;
    }

    #chart {
      width: 100%;
      max-width: 1100px;
      height: 480px;
    }

    .uplot {
      background: #0a0a0a;
    }

    .u-legend {
      color: var(--text);
      background: rgba(17, 17, 17, 0.9);
      border: 1px solid #242424;
      border-radius: 6px;
      padding: 6px 8px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
    }

    .u-legend .u-label {
      font-weight: 600;
      font-size: 12px;
      letter-spacing: 0.2px;
    }

    .u-legend .u-value {
      font-family: "Roboto Mono", monospace;
      font-size: 12px;
      color: #c7c7c7;
    }

    .u-legend .u-series:nth-child(2) .u-label,
    .u-legend .u-series:nth-child(2) .u-value {
      color: var(--accent);
    }
  </style>
</head>
<body>
  <header>
    <div>Pigboy Geophone Monitor</div>
    <div id="status">Connecting...</div>
  </header>
  <div id="container">
    <div id="chart"></div>
  </div>

  <script src="/static/vendor/uplot-lite.js"></script>
  <script>
    const statusEl = document.getElementById('status');
    const chartEl = document.getElementById('chart');

    const WINDOW_SECONDS = 10;
    const state = {
      times: [],
      geo: [],
      plot: null,
    };

    function initChart() {
      state.plot = new uPlot({
        width: chartEl.clientWidth,
        height: chartEl.clientHeight,
        background: '#000',
        scales: {
          x: { time: false },
          y: { auto: true },
        },
        axes: [
          {
            label: 'Seconds',
            stroke: '#a0a0a0',
            grid: { stroke: '#1f1f1f', width: 1 },
          },
          {
            label: 'Volts',
            stroke: '#a0a0a0',
            grid: { stroke: '#1f1f1f', width: 1 },
          },
        ],
        legend: {
          show: true,
          live: true,
        },
        series: [
          {},
          { label: 'Geophone', stroke: '#6cff5f', width: 1.5 },
        ],
        hooks: {
          setSize: [() => state.plot?.redraw?.()],
        },
      }, [[], []], chartEl);
    }

    function dropExpiredSamples(cutoff) {
      if (!state.times.length) return;
      let startIdx = 0;
      const tArr = state.times;
      while (startIdx < tArr.length && tArr[startIdx] < cutoff) {
        startIdx++;
      }
      if (startIdx > 0) {
        state.times = state.times.slice(startIdx);
        state.geo = state.geo.slice(startIdx);
      }
    }

    function updateChart(newTimes, newGeo) {
      if (!state.plot || !newTimes.length || !newGeo.length) return;

      state.times.push(...newTimes);
      state.geo.push(...newGeo);

      const latest = state.times[state.times.length - 1];
      const cutoff = latest - WINDOW_SECONDS;

      dropExpiredSamples(cutoff);

      if (!state.times.length) return;

      const windowStart = Math.max(cutoff, state.times[0]);
      const displayTimes = state.times.map((t) => t - windowStart);

      state.plot.setData([displayTimes, state.geo]);
    }

    canvas.addEventListener('mousedown', (event) => {
      if (!tData.length) return;
      if (event.shiftKey) {
        isPanning = true;
        panStartX = event.clientX;
        panStartView = viewStart;
      } else {
        isSelecting = true;
        const rect = canvas.getBoundingClientRect();
        selectStartX = Math.min(Math.max(event.clientX - rect.left, 0), canvas.width);
        selectCurrentX = selectStartX;
      }
      followLive = false;
      drawTrace();
    });

    window.addEventListener('mousemove', (event) => {
      if (!tData.length) return;
      const rect = canvas.getBoundingClientRect();
      const x = Math.min(Math.max(event.clientX - rect.left, 0), canvas.width);

      if (isPanning) {
        const dx = event.clientX - panStartX;
        const deltaT = (dx / canvas.width) * viewSpan;
        viewStart = panStartView - deltaT;
        clampView();
        drawTrace();
      } else if (isSelecting) {
        selectCurrentX = x;
        drawTrace();
      }
    });

    window.addEventListener('mouseup', () => {
      if (isSelecting) {
        const x0 = Math.min(selectStartX, selectCurrentX);
        const x1 = Math.max(selectStartX, selectCurrentX);
        if (Math.abs(x1 - x0) > 4) {
          const tStart = viewStart + (x0 / canvas.width) * viewSpan;
          const tEnd = viewStart + (x1 / canvas.width) * viewSpan;
          viewStart = tStart;
          viewSpan = Math.max(0.1, tEnd - tStart);
          clampView();
        }
        isSelecting = false;
        drawTrace();
      }

      if (isPanning) {
        isPanning = false;
      }
    });

    followBtn.addEventListener('click', () => {
      viewSpan = Math.min(BUFFER_SECONDS, Math.max(viewSpan, DEFAULT_VIEW_SECONDS));
      setLiveView();
    });

    function connectWS() {
      const proto = (location.protocol === 'https:') ? 'wss://' : 'ws://';
      const wsUrl = proto + location.host + '/ws';
      const ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        statusEl.textContent = 'Connected';
        statusEl.style.color = 'var(--accent)';
      };

      ws.onclose = () => {
        statusEl.textContent = 'Disconnected, retrying...';
        statusEl.style.color = 'var(--warn)';
        setTimeout(connectWS, 2000);
      };

      ws.onerror = () => {
        statusEl.textContent = 'Error';
        statusEl.style.color = 'var(--error)';
      };

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          const t = Array.isArray(msg.t) ? msg.t : [];
          const geo = Array.isArray(msg.geo) ? msg.geo : [];
          if (t.length && geo.length) {
            updateChart(t, geo);
          }
        } catch (e) {
          console.error('Bad message', e);
        }
      };
    }

    initChart();
    connectWS();
    drawTrace();
  </script>
</body>
</html>
